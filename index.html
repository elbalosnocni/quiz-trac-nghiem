<script>
/* ===== DOM ===== */
const startBox = document.getElementById("start");
const quizBox  = document.getElementById("quiz");
const endBox   = document.getElementById("end");

const nameEl  = document.getElementById("name");
const codeEl  = document.getElementById("code");
const timerEl = document.getElementById("timer");
const bar     = document.getElementById("bar");
const qEl     = document.getElementById("q");
const aEl     = document.getElementById("a");
const result  = document.getElementById("result");

/* ===== CONFIG ===== */
const QUESTION_API_URL = "questions.json";
const TOTAL_QUESTIONS = 20;
const PASS_SCORE = 14;
const EXAM_TIME = 1200;

let questionBank=[],questions=[],index=0,score=0,time=EXAM_TIME,timer,user={};

function shuffle(a){return a.sort(()=>Math.random()-0.5)}

async function start(){
 const name=nameEl.value.trim();
 const code=codeEl.value.trim();
 if(!name||!code) return alert("Nháº­p Ä‘á»§ thÃ´ng tin");
 if(localStorage.getItem("done_"+code)) return alert("MÃ£ NV Ä‘Ã£ thi");

 user={name,code};

 const res = await fetch(QUESTION_API_URL);
 questionBank = await res.json();

 if(questionBank.length < TOTAL_QUESTIONS)
   return alert("ChÆ°a Ä‘á»§ cÃ¢u há»i");

 prepareExam();
 startBox.style.display='none';
 quizBox.style.display='block';
 startTimer();
 load();
}

function prepareExam(){
 questions = shuffle([...questionBank])
  .slice(0,TOTAL_QUESTIONS)
  .map(q=>{
   let opts=q.a.map((t,i)=>({t,i}));
   opts=shuffle(opts);
   return {q:q.q,opts,correct:opts.findIndex(o=>o.i===q.c)};
 });
}

function startTimer(){
 timerEl.innerText="â±ï¸ "+time+"s";
 timer=setInterval(()=>{
  time--;
  timerEl.innerText="â±ï¸ "+time+"s";
  if(time<=0) finish();
 },1000);
}

function load(){
 bar.style.width=(index/questions.length*100)+"%";
 qEl.innerText=`CÃ¢u ${index+1}: ${questions[index].q}`;
 aEl.innerHTML="";
 questions[index].opts.forEach((o,i)=>{
  aEl.innerHTML+=`
   <label>
     <input type="radio" name="ans" value="${i}"> ${o.t}
   </label><br>`;
 });
}

function next(){
 const c=document.querySelector('input[name=ans]:checked');
 if(!c) return alert("Chá»n Ä‘Ã¡p Ã¡n");
 if(+c.value===questions[index].correct) score++;
 index++;
 index<questions.length?load():finish();
}

function finish(){
 clearInterval(timer);
 quizBox.style.display='none';
 endBox.style.display='block';
 localStorage.setItem("done_"+user.code,1);
 const pass = score>=PASS_SCORE;
 result.innerHTML=`
 ğŸ‘¤ ${user.name}<br>
 ğŸ†” ${user.code}<br>
 Äiá»ƒm: ${score}/${TOTAL_QUESTIONS}<br>
 <b style="color:${pass?'green':'red'}">
 ${pass?'PASS':'FAIL'}
 </b>`;
}
</script>
